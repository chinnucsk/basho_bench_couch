% Copyright 2011,  Filipe David Manana  <fdmanana@apache.org>
% Web site:  http://github.com/fdmanana/basho_bench_couch
%
% Licensed under the Apache License, Version 2.0 (the "License"); you may not
% use this file except in compliance with the License. You may obtain a copy of
% the License at
%
%   http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
% WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
% License for the specific language governing permissions and limitations under
% the License.

-module(couch_test_common).

-export([create_db/2, delete_db/2, set_delayed_commits/2]).



delete_db(#state{db_url = DbUrl, ibrowse_opts = Opts}) ->
    catch (ibrowse:send_req(DbUrl, [], delete, [], Opts, ?TIMEOUT)).


create_db(#state{db_url = DbUrl, ibrowse_opts = Opts}) ->
    case ibrowse:send_req(DbUrl, [], put, [], Opts, ?TIMEOUT) of
    {ok, "201", _Headers, _Body} ->
        ok;
    {ok, Code, _Headers, _Body} ->
        exit("Error creating test database: return code is " ++ Code);
    Error ->
        exit("Error creating test database: " ++ to_list(Error))
    end.


set_delayed_commits(#state{server = Url, ibrowse_opts = Opts}) ->
    DelayedCommits = json_encode(basho_bench_config:get(couch_delayed_commits, false)),
    case ibrowse:send_req(Url ++ "/_config/couchdb/delayed_commits", [], put,
                          DelayedCommits, Opts, ?TIMEOUT) of
    {ok, "200", _Headers, _Body} ->
        ok;
    {ok, Code, _Headers, _Body} ->
        exit("Error setting delayed_commits: return code is " ++ Code);
    Error ->
        exit("Error setting delayed_commits: " ++ to_list(Error))
    end.
